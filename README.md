# Сервис генерации коротких ссылок

---

## Архитектура и Компоненты

Сервис использует архитектуру **Controller → Service → Repository** с добавлением планировщика для фонового обслуживания.

| Компонент | Ключевая роль |
|------------|----------------|
| **LinkController** | API-интерфейс (POST/GET). Обрабатывает запросы, управляет Cookie (`SHORTLINK_USER`) и заголовком `X-User-ID`. |
| **ShortLinkService** | Основная бизнес-логика: генерация кода, проверка коллизий (до 6 попыток), проверка условий редиректа. |
| **CleanupScheduler** | Фоновая задача (Cron). Периодически деактивирует просроченные ссылки и удаляет их из БД. |
| **NotificationService** | Отправка уведомлений пользователю о деактивации ссылки (истек TTL или лимит кликов). |

---

## Настройка и Запуск

Проект собирается и запускается с помощью **Maven**, используя конфигурацию в `application.yml`.

**Критическая конфигурация:**
```properties
app.base-url=http://localhost:8080/
app.ttl=24  # Время жизни ссылки по умолчанию в часах (24 часа)
```

## ⚙Запуск через Maven

```bash
# Сборка проекта
mvn clean install

# Запуск приложения
mvn spring-boot:run
```
## Детали бизнес-логики

### Создание ссылки (`POST /shorten`)

1. **Идентификация пользователя**
    - Проверяется заголовок `X-User-ID`.
    - Если отсутствует → генерируется новый `UUID` и сохраняется в `Cookie`.

2. **Генерация кода**
    - Используется `ShortCodeGenerator` для создания уникального 6-символьного кода.
    - При коллизии — до **5 повторных попыток**.

3. **Жизненный цикл ссылки**
    - Устанавливается срок действия `expiresAt` (на основе `app.ttl` из конфигурации).
    - Сохраняется лимит переходов `maxClicks`.

---

### Перенаправление (`GET /{code}`)

1. **Поиск**
    - Выполняется поиск ссылки по `code`.
    - Если не найдена → `404 Not Found`.

2. **Проверки**
    - Ссылка **неактивна** (`isActive = false`) → отказ.
    - **Истек срок действия** (`expiresAt < now`) → деактивировать, уведомить пользователя, отказ.
    - **Достигнут лимит кликов** (`clicks >= maxClicks`) → деактивировать, уведомить пользователя, отказ.

3. **Переход**
    - Если все проверки пройдены → атомарно увеличивается счётчик `clicks`.
    - Возвращается `302 Redirect` на `originalUrl`.

## Тестирование

- Реализованы **unit-тесты** для слоя бизнес-логики `ShortLinkService`.
- Тестируются ключевые сценарии:
    - Создание ссылки и генерация кода.
    - Обработка истечения срока действия.
    - Проверка лимита кликов.
    - Корректное перенаправление при валидной ссылке.
    - Деактивация и ошибки при нарушении условий.